apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agenticsessions.vteam.ambient-code
  # Migration Annotations:
  # - ambient-code.io/repos-migrated: "v2" - Marks sessions migrated from legacy repo format.
  #   Added by operator during startup migration. Prevents re-migration on subsequent restarts.
  # - ambient-code.io/migration-skipped-active: "Running|Creating" - Marks active sessions skipped during migration.
  #   Allows tracking which sessions need migration once they complete. Value indicates phase at skip time.
spec:
  group: vteam.ambient-code
  versions:
  - name: v1alpha1
    served: true
    storage: true
    subresources:
      status: {}
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              # Repository configuration
              repos:
                type: array
                description: "List of Git repositories to clone and work with"
                items:
                  type: object
                  properties:
                    # New structure (preferred)
                    input:
                      type: object
                      description: "Input repository configuration (source to clone)"
                      required:
                        - url
                      properties:
                        url:
                          type: string
                          description: "Git repository URL"
                          minLength: 1
                        branch:
                          type: string
                          description: "Branch to checkout"
                          default: "main"
                    output:
                      type: object
                      description: "Output repository configuration (target for push). If not specified, pushes to input repo."
                      required:
                        - url
                      properties:
                        url:
                          type: string
                          description: "Git repository URL (typically a fork)"
                          minLength: 1
                        branch:
                          type: string
                          description: "Branch to push to"
                    autoPush:
                      type: boolean
                      default: false
                      description: "When true, automatically commit and push changes to this repository after session completion. Overrides session-level autoPushOnComplete for this repo."
                    # Legacy structure (deprecated, for backwards compatibility)
                    url:
                      type: string
                      description: "[DEPRECATED] Git repository URL. Use 'input.url' instead."
                    branch:
                      type: string
                      description: "[DEPRECATED] Branch to checkout. Use 'input.branch' instead."
              interactive:
                type: boolean
                description: "When true, run session in interactive chat mode using inbox/outbox files"
                default: true
              initialPrompt:
                type: string
                description: "Initial prompt used only on first SDK invocation for brand new sessions (ignored on continuations or workflow restarts)."
              displayName:
                type: string
                description: "A descriptive display name for the agentic session generated from prompt and website"
              userContext:
                type: object
                description: "Authenticated caller identity captured at creation time (used for authorization and audit)"
                properties:
                  userId:
                    type: string
                    description: "Stable user identifier (from SSO, always overwritten from auth token)"
                  displayName:
                    type: string
                    description: "Human-readable display name"
                  groups:
                    type: array
                    items:
                      type: string
                    description: "Group memberships of the user"
              llmSettings:
                type: object
                properties:
                  model:
                    type: string
                    default: "claude-3-7-sonnet-latest"
                  temperature:
                    type: number
                    default: 0.7
                  maxTokens:
                    type: integer
                    default: 4000
                description: "LLM configuration settings"
              timeout:
                type: integer
                default: 300
                description: "Timeout in seconds for the agentic session"
              autoPushOnComplete:
                type: boolean
                default: false
                description: "When true, the runner will commit and push changes automatically after it finishes"
              activeWorkflow:
                type: object
                description: "Active workflow configuration for dynamic workflow switching"
                properties:
                  gitUrl:
                    type: string
                    description: "Git repository URL for the workflow"
                  branch:
                    type: string
                    description: "Branch to clone"
                    default: "main"
                  path:
                    type: string
                    description: "Optional path within repo (for repos with multiple workflows)"
          status:
            type: object
            properties:
              observedGeneration:
                type: integer
                format: int64
                description: "Spec generation that the operator has fully reconciled."
              phase:
                type: string
                enum:
                - "Pending"
                - "Creating"
                - "Running"
                - "Stopping"
                - "Stopped"
                - "Completed"
                - "Failed"
                default: "Pending"
              startTime:
                type: string
                format: date-time
                description: "Timestamp when the session runner started executing."
              completionTime:
                type: string
                format: date-time
                description: "Timestamp when the session reached a terminal phase."
              reconciledRepos:
                type: array
                description: "Current reconciliation state for each repository."
                items:
                  type: object
                  properties:
                    url:
                      type: string
                    branch:
                      type: string
                    name:
                      type: string
                    status:
                      type: string
                      enum:
                      - "Cloning"
                      - "Ready"
                      - "Failed"
                    clonedAt:
                      type: string
                      format: date-time
              reconciledWorkflow:
                type: object
                description: "Current reconciliation state for the active workflow."
                properties:
                  gitUrl:
                    type: string
                  branch:
                    type: string
                  path:
                    type: string
                    description: "Optional path within the workflow repository"
                  status:
                    type: string
                    enum:
                    - "Cloning"
                    - "Active"
                    - "Failed"
                  appliedAt:
                    type: string
                    format: date-time
              sdkSessionId:
                type: string
                description: "SDK session identifier captured for resume support."
              sdkRestartCount:
                type: integer
                description: "Number of times the SDK has been restarted during this session."
              conditions:
                type: array
                description: "Detailed condition set describing reconciliation progress."
                items:
                  type: object
                  required:
                  - type
                  - status
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                      enum:
                      - "True"
                      - "False"
                      - "Unknown"
                    reason:
                      type: string
                    message:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
                    observedGeneration:
                      type: integer
                      format: int64
  scope: Namespaced
  names:
    plural: agenticsessions
    singular: agenticsession
    kind: AgenticSession
    shortNames:
    - as
